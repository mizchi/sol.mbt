/**
 * TypeScript Routes - Hybrid Mode Test
 *
 * This demonstrates using TypeScript for server-side routing
 * while keeping MoonBit (Luna UI) for client-side components.
 */

import {
  SolRoutes,
  type PageProps,
  type RouterConfig,
  type SolRoute,
} from '../../../../js/sol/routes';

import {
  div, h1, h2, p, a, ul, li, nav, text, renderToString,
} from '../../../../js/sol/html';

// ============================================================================
// Layouts
// ============================================================================

async function rootLayout(props: PageProps, children: string): Promise<string> {
  const navigation = renderToString(
    nav({ class: 'main-nav' }, [
      ul({}, [
        li({}, [a({ href: '/' }, [text('Home')])]),
        li({}, [a({ href: '/about' }, [text('About')])]),
        li({}, [a({ href: '/api/health' }, [text('API Health')])]),
      ]),
    ])
  );

  return `
    <div class="app-container">
      ${navigation}
      <main>${children}</main>
    </div>
  `;
}

// ============================================================================
// Pages
// ============================================================================

async function homePage(props: PageProps): Promise<string> {
  return renderToString(
    div({}, [
      h1({}, [text('Welcome to Sol (Hybrid Mode)')]),
      p({}, [text('This page is rendered by TypeScript routes.ts')]),
      p({}, [text('Client-side islands (Luna UI) are still powered by MoonBit.')]),
      div({ class: 'counter-demo' }, [
        h2({}, [text('Counter Island')]),
        p({}, [text('The counter below is a MoonBit island (if available):')]),
        // Island placeholder - would be hydrated by MoonBit client
        text('<div data-island="counter" data-props="{}"></div>'),
      ]),
    ])
  );
}

async function aboutPage(props: PageProps): Promise<string> {
  return renderToString(
    div({}, [
      h1({}, [text('About')]),
      p({}, [text('This is the about page, rendered by TypeScript.')]),
      p({}, [text('Path: ' + props.params.path)]),
    ])
  );
}

// ============================================================================
// API Handlers
// ============================================================================

async function apiHealth(props: PageProps): Promise<unknown> {
  return {
    status: 'ok',
    mode: 'hybrid',
    timestamp: new Date().toISOString(),
  };
}

// ============================================================================
// Route Definitions
// ============================================================================

export function routes(): SolRoute[] {
  return [
    SolRoutes.Layout({
      segment: '',
      layout: rootLayout,
      children: [
        SolRoutes.Page({
          path: '/',
          handler: homePage,
          title: 'Home',
        }),
        SolRoutes.Page({
          path: '/about',
          handler: aboutPage,
          title: 'About',
        }),
      ],
    }),
    SolRoutes.Get({
      path: '/api/health',
      handler: apiHealth,
    }),
  ];
}

export function config(): RouterConfig {
  return {
    titlePrefix: 'Sol App (Hybrid)',
    defaultHead: `
      <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .main-nav ul { display: flex; gap: 20px; list-style: none; padding: 0; }
        .main-nav a { text-decoration: none; color: #0066cc; }
        .counter-demo { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
      </style>
    `,
  };
}
